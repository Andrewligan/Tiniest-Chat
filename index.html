<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebGL Background</title>
  <style>
    *, *::before, *::after {
        box-sizing: border-box;
    }

    :root {
        --background-color: #000;
        --text-color: #fff;
        --bubble-rgb: 255, 255, 255;
        --bubble-text-color: #000;
        --text-color-rgb: 255, 255, 255;
        --bubble-opacity: 0.75;
        --font-size-multiplier: 1.0;
        --neutral-dark: #333;
        --neutral-light: #ccc;
    }
    
    body.light-mode {
        --background-color: #fff;
        --text-color: #000;
        --bubble-rgb: 0, 0, 0;
        --bubble-text-color: #fff;
        --text-color-rgb: 0, 0, 0;
    }
  
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: var(--text-color);
        background-color: var(--background-color);
        transition: color 0.3s, background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden;
    }

    #glcanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
    
    .content {
        position: relative;
        z-index: 1;
        padding: 2rem;
        text-align: center;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        height: 100vh;
    }
    
    h1, h2 {
        margin: 0;
    }
    
    h1 {
        font-size: calc(3rem * var(--font-size-multiplier));
        font-weight: 800;
    }
    
    .text-bubble {
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        color: var(--bubble-text-color);
        padding: 1rem 1.5rem;
        border-radius: 1.5rem;
        transition: background-color 0.3s, color 0.3s;
        width: 100%;
        max-width: 600px;
    }
    
    /* --- Chat Area --- */
    #chat-area {
        flex-grow: 1;
        width: 100%;
        display: flex;
        flex-direction: column-reverse;
        gap: 1rem;
        overflow-y: auto;
        padding: 1rem;
    }

    .message-bubble {
        padding: 1rem 1.5rem;
        border-radius: 1.5rem;
        max-width: 80%;
        word-wrap: break-word;
        font-size: calc(1rem * var(--font-size-multiplier));
        text-align: left;
    }

    .user-message {
        background-color: rgba(var(--text-color-rgb), var(--bubble-opacity));
        color: var(--background-color);
        align-self: flex-end;
    }

    .model-message {
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        color: var(--bubble-text-color);
        align-self: flex-start;
    }

    /* --- Unified Collapsible Component Styles --- */
    .collapsible-container {
        position: fixed;
        z-index: 10;
        display: flex;
        gap: 0.5rem;
        transition: transform 0.4s ease-in-out;
    }
    
    .collapsible-container--right {
        top: 1.5rem;
        right: 1.5rem;
        align-items: center;
    }
    
    .collapsible-container--top {
        top: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column-reverse;
        align-items: center;
    }

    .collapsible-panel {
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        padding: 1rem;
        border-radius: 1rem;
        color: var(--bubble-text-color);
        transition: background-color 0.3s, color 0.3s;
        display: flex;
        flex-direction: column;
    }
    
    .side-panel {
        gap: 1rem;
        font-size: calc(0.8rem * var(--font-size-multiplier));
    }

    .top-panel {
        width: 100%;
        max-width: 500px;
        font-size: calc(0.9rem * var(--font-size-multiplier));
        gap: 1rem;
    }

    .collapsible-toggle {
        width: 48px;
        height: 48px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        border-radius: 1.8rem;
        transition: background-color 0.3s, transform 0.2s ease-in-out;
        flex-shrink: 0;
    }
    
    .collapsible-toggle:hover {
        transform: scale(1.15);
    }

    .collapsible-toggle svg {
        width: 24px;
        fill: var(--bubble-text-color);
        transition: transform 0.4s ease-in-out, fill 0.3s;
    }

    .collapsible-container--right.collapsed {
        transform: translateX(calc(100% - 48px));
    }
    .collapsible-container--right.collapsed .collapsible-toggle svg {
        transform: rotate(180deg);
    }
    
    .collapsible-container--top.collapsed {
        transform: translate(-50%, calc(-100% + 48px));
    }
    .collapsible-container--top:not(.collapsed) .collapsible-toggle svg {
        transform: rotate(180deg);
    }
    
    /* --- Theme Toggle Switch --- */
    .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    .theme-switch {
        display: inline-block;
        height: 24px;
        position: relative;
        width: 44px;
    }
    .theme-switch input { display:none; }
    .slider {
        background-color: var(--neutral-dark);
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: .4s;
        border-radius: 24px;
    }
    .slider:before {
        background-color: #fff;
        bottom: 4px;
        content: "";
        height: 16px;
        left: 4px;
        position: absolute;
        transition: .4s;
        width: 16px;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: var(--neutral-light);
    }
    input:checked + .slider:before {
        background-color: var(--neutral-dark);
        transform: translateX(20px);
    }

    /* --- Custom Slider Styles --- */
    .slider-control {
        -webkit-appearance: none;
        width: 120px;
        height: 8px;
        background: var(--neutral-dark);
        outline: none;
        opacity: 0.7;
        transition: opacity .2s, background .3s;
        border-radius: 4px;
    }
    .slider-control:hover { opacity: 1; }
    .slider-control::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #ddd;
        cursor: pointer;
        border-radius: 50%;
        transition: background .3s;
    }
    body.light-mode .slider-control {
        background: var(--neutral-light);
    }
    body.light-mode .slider-control::-webkit-slider-thumb {
        background: var(--neutral-dark);
    }

    /* --- Themed Input & Button Styles --- */
    .button-container {
        display: flex;
        justify-content: flex-end;
    }
    .themed-input {
        background-color: rgba(var(--background-color), 0.5);
        color: var(--bubble-text-color);
        border: 1px solid var(--bubble-text-color);
        padding: 0.5rem;
        border-radius: 0.5rem;
        font-family: inherit;
        font-size: inherit;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        width: 100%;
    }
    .themed-input::placeholder {
        color: var(--bubble-text-color);
        opacity: 0.5;
    }
    .themed-button {
        background-color: var(--background-color);
        color: var(--text-color);
        border: 1px solid rgba(var(--text-color), 0.3);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-family: inherit;
        font-size: calc(0.8rem * var(--font-size-multiplier));
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s, transform 0.2s;
    }
    .themed-button:hover {
        background-color: var(--text-color);
        color: var(--background-color);
        transform: scale(1.02);
    }
    
    .themed-button.disabled {
        background-color: rgba(var(--bubble-rgb), 0.2);
        color: rgba(var(--bubble-text-color), 0.5);
        border-color: rgba(var(--bubble-text-color), 0.2);
        cursor: not-allowed;
        pointer-events: none;
    }

    /* --- Main Chat Input Styles --- */
    #chat-input-area {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
    }

    .chat-input-bubble {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }
    .tag-buttons-container {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap;
    }
    .chat-input-container {
        display: flex;
        align-items: center;
        width: 100%;
        font-size: calc(1.25rem * var(--font-size-multiplier));
    }
    .chat-input-container .themed-input {
        background: none;
        border: none;
        outline: none;
        flex-grow: 1;
        height: auto;
        padding: 0;
    }
    .chat-input-container .themed-input::placeholder {
        color: var(--bubble-text-color);
        opacity: 0.7;
    }
    .chat-input-button {
        background: none;
        border: none;
        padding: 0 0 0 1rem;
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
        flex-shrink: 0;
    }
    .chat-input-button:hover {
        transform: scale(1.15);
    }
    .chat-input-button svg {
        width: 24px;
        height: 24px;
        fill: var(--bubble-text-color);
    }
    
    /* --- Models & Parameters Panel --- */
    .models-panel-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translate(-50%, 100%); /* Start hidden below screen */
        z-index: 20;
        width: 66.66%;
        max-width: calc(800px * var(--font-size-multiplier));
        height: 85vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: calc(0.5rem * var(--font-size-multiplier));
        transition: transform 0.4s ease-in-out;
    }
    .models-panel-container.visible {
        transform: translate(-50%, 0); /* Slide into view */
    }
    #parameters-panel-container {
        z-index: 21; /* Ensure it's on top */
    }
    .models-panel {
        width: 100%;
        height: 100%;
        border-radius: calc(1.8rem * var(--font-size-multiplier));
        padding: calc(1.5rem * var(--font-size-multiplier));
    }
    .models-panel-toggle {
        order: -1; /* Place toggle above the panel */
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: calc(1rem * var(--font-size-multiplier));
        margin-bottom: calc(1.5rem * var(--font-size-multiplier));
    }
    #parameters-panel-container .panel-header {
        justify-content: center;
    }

     .panel-header h2 {
        font-size: calc(1.5rem * var(--font-size-multiplier));
        white-space: nowrap;
     }
     
     .panel-header .themed-input {
        font-size: calc(1rem * var(--font-size-multiplier));
     }

    #models-list, #parameters-list {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: calc(0.5rem * var(--font-size-multiplier)); /* Dynamic padding for scrollbar */
    }
    
    #models-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(calc(280px * var(--font-size-multiplier)), 1fr));
        gap: calc(1rem * var(--font-size-multiplier));
    }
    
    #parameters-list {
        display: flex;
        flex-direction: column;
        gap: calc(1rem * var(--font-size-multiplier));
    }

    .helper-text {
        color: var(--bubble-text-color);
        opacity: 0.7;
        font-size: calc(1rem * var(--font-size-multiplier));
        text-align: center;
        padding-top: calc(2rem * var(--font-size-multiplier));
    }
    
    .model-card {
        background-color: var(--background-color);
        color: var(--text-color);
        border: 1px solid rgba(var(--text-color), 0.3);
        padding: calc(1rem * var(--font-size-multiplier));
        border-radius: calc(1rem * var(--font-size-multiplier));
        font-family: inherit;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s, transform 0.2s;
        display: flex;
        flex-direction: column;
        gap: calc(0.75rem * var(--font-size-multiplier));
        text-align: left;
    }
    .model-card:hover {
        background-color: var(--text-color);
        color: var(--background-color);
        transform: translateY(-4px);
    }
    .model-card h3 {
        font-size: calc(1.1rem * var(--font-size-multiplier));
        margin: 0;
        font-weight: 600;
    }
    .model-card p {
        font-size: calc(0.85rem * var(--font-size-multiplier));
        margin: 0;
        opacity: 0.8;
        flex-grow: 1;
    }
    .model-card-footer {
        display: flex;
        flex-wrap: wrap;
        gap: calc(0.5rem * var(--font-size-multiplier));
        font-size: calc(0.75rem * var(--font-size-multiplier));
    }
    .card-tag {
        background-color: var(--text-color);
        color: var(--background-color);
        padding: calc(0.2rem * var(--font-size-multiplier)) calc(0.6rem * var(--font-size-multiplier));
        border-radius: calc(0.75rem * var(--font-size-multiplier));
        transition: background-color 0.3s, color 0.3s;
    }
    .model-card:hover .card-tag {
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    /* --- Custom Scrollbar Styles --- */
    #models-list::-webkit-scrollbar, #parameters-list::-webkit-scrollbar, #chat-area::-webkit-scrollbar {
      width: 12px;
    }
    #models-list::-webkit-scrollbar-track, #parameters-list::-webkit-scrollbar-track, #chat-area::-webkit-scrollbar-track {
      background: var(--background-color);
      border-radius: 10px;
    }
    #models-list::-webkit-scrollbar-thumb, #parameters-list::-webkit-scrollbar-thumb, #chat-area::-webkit-scrollbar-thumb {
      background-color: var(--text-color);
      border-radius: 10px;
      border: 3px solid var(--background-color);
      background-clip: content-box;
    }
    #models-list::-webkit-scrollbar-thumb:hover, #parameters-list::-webkit-scrollbar-thumb:hover, #chat-area::-webkit-scrollbar-thumb:hover {
      background-color: var(--text-color);
      opacity: 0.8;
    }


    @media (max-width: 600px) {
        .collapsible-container--right {
            top: auto;
            bottom: 1.5rem;
        }
        .models-panel-container {
            width: 90%;
        }
        #models-list {
            grid-template-columns: 1fr;
        }
    }

  </style>
</head>
<body>
  
  <div class="collapsible-container collapsible-container--top collapsed">
      <div class="collapsible-toggle" id="top-dropdown-toggle">
          <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
      </div>
      <div class="collapsible-panel top-panel">
        <form id="save-form">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="password" class="themed-input" id="api-key-input" name="password" autocomplete="current-password" placeholder="API Key">
                <div class="button-container">
                    <button type="submit" class="themed-button">Save</button>
                </div>
            </div>
        </form>
      </div>
  </div>

  <div class="collapsible-container collapsible-container--right">
    <div class="collapsible-toggle" id="side-panel-toggle">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
    </div>
    <div class="collapsible-panel side-panel">
        <div class="control-row">
            <span>Theme</span>
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
        </div>
        <div class="control-row">
          <span>Animation</span>
          <label class="theme-switch">
              <input type="checkbox" id="animation-toggle" checked />
              <span class="slider"></span>
          </label>
      </div>
        <div class="control-row">
            <label for="opacity-slider">Opacity</label>
            <input type="range" min="0" max="100" value="75" class="slider-control" id="opacity-slider">
        </div>
        <div class="control-row">
            <label for="background-zoom-slider">BG Zoom</label>
            <input type="range" min="2" max="80" value="80" class="slider-control" id="background-zoom-slider">
        </div>
        <div class="control-row">
            <label for="text-size-slider">Text Size</label>
            <input type="range" min="50" max="150" value="100" class="slider-control" id="text-size-slider">
        </div>
    </div>
  </div>

  <div class="content">
      <div id="chat-area">
         <!-- Messages dynamically added here -->
      </div>
      <div id="chat-input-area" class="text-bubble">
        <div class="chat-input-bubble">
          <div class="tag-buttons-container">
              <button class="themed-button" id="models-button">Models</button>
          </div>
          <div class="chat-input-container">
              <input type="text" class="themed-input" id="chat-prompt-input" placeholder="Message...">
              <button class="chat-input-button" id="send-button">
                  <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
              </button>
          </div>
        </div>
      </div>
  </div>

  <div id="models-panel-main-container" class="models-panel-container">
      <div class="collapsible-toggle models-panel-toggle" id="models-panel-main-toggle">
          <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
      </div>
      <div class="collapsible-panel models-panel">
          <div class="panel-header">
            <h2>Available Models</h2>
            <input type="text" class="themed-input" id="model-search-input" placeholder="Search...">
            <button class="themed-button" id="refresh-models-button">Refresh</button>
          </div>
          <div id="models-list">
             <!-- Models will be dynamically inserted here -->
          </div>
      </div>
  </div>

  <div id="parameters-panel-container" class="models-panel-container">
    <div class="collapsible-toggle models-panel-toggle" id="parameters-panel-close">
        <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
    </div>
    <div class="collapsible-panel models-panel">
        <div class="panel-header">
          <h2>Supported Parameters</h2>
        </div>
        <div id="parameters-list">
           <!-- Parameters will be dynamically inserted here -->
        </div>
    </div>
  </div>

  <canvas id="glcanvas"></canvas>
  <iframe name="form-target" style="display: none;"></iframe>

  <script id="vertexShader" type="x-shader/x-vertex">
    attribute vec2 a_position;
    varying vec2 v_uv;
    void main() {
      v_uv = a_position * 0.5 + 0.5;
      gl_Position = vec4(a_position, 0.0, 1.0);
    }
  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">
    precision highp float;
    varying vec2 v_uv;
    uniform float u_time;
    uniform float u_zoom;
    uniform float u_is_dark_mode;
    
    float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
    float noise(vec2 p) {
      vec2 i = floor(p); vec2 f = fract(p); vec2 u = f*f*(3.0-2.0*f);
      return mix(mix(hash(i + vec2(0.0, 0.0)), hash(i + vec2(1.0, 0.0)), u.x),
                 mix(hash(i + vec2(0.0, 1.0)), hash(i + vec2(1.0, 1.0)), u.x), u.y);
    }
    float fbm(vec2 p) {
      float f = 0.0; float amp = 0.5;
      for (int i = 0; i < 4; i++) { f += amp * noise(p); p *= 2.0; amp *= 0.5; }
      return f;
    }
    vec2 voronoi(vec2 p) {
      vec2 i = floor(p); vec2 f = fract(p);
      float min_dist=1.0, second_min_dist=1.0;
      for (int y=-1; y<=1; y++) {
        for (int x=-1; x<=1; x++) {
          vec2 nc = vec2(float(x), float(y));
          float d = fbm((i + nc) * 0.1 + u_time * 0.005);
          vec2 p_ = nc + 0.5 + (d - 0.5) * 0.8;
          float dist = length(f - p_);
          if (dist < min_dist) { second_min_dist = min_dist; min_dist = dist; }
          else if (dist < second_min_dist) { second_min_dist = dist; }
        }
      }
      return vec2(min_dist, second_min_dist);
    }

    void main() {
      vec2 p = v_uv * u_zoom; p.x += u_time * 0.002;
      vec2 v = voronoi(p);
      float border = smoothstep(0.01, 0.0125, v.y - v.x);
      vec3 color = mix(vec3(border), vec3(1.0 - border), u_is_dark_mode);
      gl_FragColor = vec4(color, 1.0);
    }
  </script>

  <script>
    const root = document.documentElement;
    
    // --- UI Controls ---
    const themeToggle = document.getElementById('theme-toggle');
    const animationToggle = document.getElementById('animation-toggle');
    const opacitySlider = document.getElementById('opacity-slider');
    const textSizeSlider = document.getElementById('text-size-slider');
    const backgroundZoomSlider = document.getElementById('background-zoom-slider');
    const sidePanelToggle = document.getElementById('side-panel-toggle');
    const topDropdownToggle = document.getElementById('top-dropdown-toggle');
    const saveForm = document.getElementById('save-form');
    const modelsButton = document.getElementById('models-button');
    const modelsPanelContainer = document.getElementById('models-panel-main-container');
    const modelsPanelToggle = document.getElementById('models-panel-main-toggle');
    const refreshModelsButton = document.getElementById('refresh-models-button');
    const modelsListContainer = document.getElementById('models-list');
    const modelSearchInput = document.getElementById('model-search-input');
    const parametersPanelContainer = document.getElementById('parameters-panel-container');
    const parametersPanelClose = document.getElementById('parameters-panel-close');
    const parametersList = document.getElementById('parameters-list');
    const chatPromptInput = document.getElementById('chat-prompt-input');
    const sendButton = document.getElementById('send-button');
    const chatArea = document.getElementById('chat-area');
    const apiKeyInput = document.getElementById('api-key-input');
    
    // --- State Management ---
    let webGLState = {
        gl: null,
        program: null,
        uniforms: {},
        animationFrameId: null,
        zoom: 80.0,
        isDarkMode: true,
        lastTime: 0,
        totalElapsedTime: 0
    };
    let modelsLoaded = false;
    let allModelsData = [];
    let currentSelectedModel = null;
    let apiKey = '';
    let chatHistory = [];

    // --- Functions ---
    const renderChatHistory = () => {
        chatArea.innerHTML = '';
        [...chatHistory].forEach(msg => {
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${msg.role === 'user' ? 'user-message' : 'model-message'}`;
            messageBubble.textContent = msg.content;
            chatArea.prepend(messageBubble);
        });
        chatArea.scrollTop = 0;
    };

    const addInitialMessage = () => {
        chatHistory.push({ role: 'assistant', content: 'Welcome to tiniest chat!'});
        renderChatHistory();
    };

    const sendMessage = async () => {
        const userPrompt = chatPromptInput.value.trim();
        if (!userPrompt) return;

        chatHistory.push({ role: 'user', content: userPrompt });

        if (!apiKey) {
            chatHistory.push({ role: 'assistant', content: 'Error: API key is not set. Please set it in the top panel.' });
            renderChatHistory();
            return;
        }
        if (!currentSelectedModel) {
            chatHistory.push({ role: 'assistant', content: 'Error: No model selected. Please select a model from the "Models" panel.' });
            renderChatHistory();
            return;
        }
        
        const thinkingMessage = { role: 'assistant', content: 'Thinking...' };
        chatHistory.push(thinkingMessage);
        renderChatHistory();
        chatPromptInput.value = '';

        const messages = chatHistory.slice(0, -1).map(msg => ({
            role: msg.role === 'user' ? 'user' : 'assistant',
            content: msg.content
        }));

        const requestBody = {
            model: currentSelectedModel.id,
            messages: messages,
        };
        
        const paramInputs = parametersList.querySelectorAll('[id^="param-"]');
        paramInputs.forEach(input => {
            const paramName = input.id.replace('param-', '');
            if(input.parentElement.matches('.theme-switch')) { 
                 if(input.querySelector('input[type="checkbox"]').checked) {
                     requestBody[paramName] = true;
                 }
            } else if (input.value) {
                 if (input.type === 'number') {
                    if(input.value !== '') requestBody[paramName] = parseFloat(input.value);
                 } else {
                    requestBody[paramName] = input.value;
                 }
            }
        });

        const headers = {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
        };

        console.log("----- Sending Request -----");
        console.log("URL:", 'https://openrouter.ai/api/v1/chat/completions');
        console.log("Headers:", headers);
        console.log("Body:", JSON.stringify(requestBody, null, 2));


        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            const responseData = await response.json();

            console.log("----- Received Response -----");
            console.log("Status:", response.status);
            console.log("Status Text:", response.statusText);
            console.log("Data:", responseData);

            if (!response.ok) {
                throw new Error(responseData.error?.message || `HTTP error! status: ${response.status}`);
            }

            const modelResponse = responseData.choices[0].message.content;
            thinkingMessage.content = modelResponse;
            thinkingMessage.role = 'assistant';


        } catch (error) {
            console.error('Error during API call:', error);
            thinkingMessage.content = `Error: ${error.message}`;
            thinkingMessage.role = 'assistant';
        }
        
        renderChatHistory();
    };

    const showSupportedParameters = (model) => {
        parametersList.innerHTML = ''; 

        if (model.supported_parameters && Array.isArray(model.supported_parameters) && model.supported_parameters.length > 0) {
            
            const paramDetails = {
                user: { type: 'string' },
                max_tokens: { type: 'integer' },
                temperature: { type: 'double', min: 0, max: 2, step: 0.1 },
                seed: { type: 'integer' },
                top_p: { type: 'double', min: 0, max: 1, step: 0.01 },
                top_k: { type: 'integer', min: 1 },
                frequency_penalty: { type: 'double', min: -2, max: 2, step: 0.1 },
                presence_penalty: { type: 'double', min: -2, max: 2, step: 0.1 },
                repetition_penalty: { type: 'double', min: 0, max: 2, step: 0.1 },
                top_logprobs: { type: 'integer' },
                min_p: { type: 'double', min: 0, max: 1, step: 0.01 },
                top_a: { type: 'double', min: 0, max: 1, step: 0.01 },
                stream: { type: 'boolean' },
                effort: { type: 'enum', values: ['low', 'medium', 'high'] }
            };

            model.supported_parameters.forEach(paramName => {
                const details = paramDetails[paramName];
                if (!details) return;

                const row = document.createElement('div');
                row.className = 'control-row';
                
                const label = document.createElement('label');
                label.textContent = paramName;
                label.setAttribute('for', `param-${paramName}`);
                
                let input;

                switch(details.type) {
                    case 'string':
                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'themed-input';
                        break;
                    case 'integer':
                    case 'double':
                         input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'themed-input';
                        if (details.min !== undefined) input.min = details.min;
                        if (details.max !== undefined) input.max = details.max;
                        if (details.step) input.step = details.step;
                        break;
                    case 'boolean':
                        input = document.createElement('label');
                        input.className = 'theme-switch';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        const slider = document.createElement('span');
                        slider.className = 'slider';
                        input.append(checkbox, slider);
                        break;
                    case 'enum':
                        input = document.createElement('select');
                        input.className = 'themed-input';
                        details.values.forEach(val => {
                            const option = document.createElement('option');
                            option.value = val;
                            option.textContent = val.charAt(0).toUpperCase() + val.slice(1);
                            input.appendChild(option);
                        });
                        break;
                }
                
                input.id = `param-${paramName}`;
                
                row.appendChild(label);
                row.appendChild(input);
                parametersList.appendChild(row);
            });
        } else {
            parametersList.innerHTML = `<p class="helper-text">No supported parameters listed for this model.</p>`;
        }

        parametersPanelContainer.classList.add('visible');
    };

    const selectModel = (model) => {
        currentSelectedModel = model;
        
        const existingButton = document.getElementById('selected-model-display-button');
        if (existingButton) {
            existingButton.remove();
        }

        const button = document.createElement('button');
        button.id = 'selected-model-display-button';
        button.className = 'themed-button';
        button.textContent = model.name;
        button.addEventListener('click', () => showSupportedParameters(model));
        
        const tagButtonsContainer = document.querySelector('.tag-buttons-container');
        tagButtonsContainer.insertBefore(button, modelsButton.nextSibling);

        modelsPanelContainer.classList.remove('visible');
    };

    const renderModelCards = (models) => {
        modelsListContainer.innerHTML = '';
        if (models.length === 0) {
            modelsListContainer.innerHTML = `<p class="helper-text">No models found.</p>`;
            return;
        }

        models.forEach(model => {
            const card = document.createElement('button');
            card.className = 'model-card';
            card.dataset.id = model.id;
            card.addEventListener('click', () => selectModel(model));

            const inputModalities = model.architecture?.input_modalities?.join(', ') || 'N/A';
            const outputModalities = model.architecture?.output_modalities?.join(', ') || 'N/A';

            const formatPrice = (price) => {
                const p = parseFloat(price);
                return p > 0 ? `$${(p * 1_000_000).toFixed(2)}/M` : 'Free';
            }

            card.innerHTML = `
                <h3>${model.name || 'Unnamed Model'}</h3>
                <p>${model.description || 'No description available.'}</p>
                <div class="model-card-footer">
                    <span class="card-tag">Context: ${model.context_length ? (model.context_length / 1000) + 'k' : 'N/A'}</span>
                    <span class="card-tag">In: ${inputModalities}</span>
                    <span class="card-tag">Out: ${outputModalities}</span>
                    <span class="card-tag">Prompt: ${formatPrice(model.pricing.prompt)}</span>
                    <span class="card-tag">Completion: ${formatPrice(model.pricing.completion)}</span>
                </div>
            `;
            
            modelsListContainer.appendChild(card);
        });
    };

    const fetchAndDisplayModels = async () => {
        modelsListContainer.innerHTML = `<p class="helper-text">Loading models...</p>`;
        try {
            const response = await fetch('https://openrouter.ai/api/v1/models');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const { data } = await response.json();
            allModelsData = data;
            renderModelCards(allModelsData);
            modelsLoaded = true;

        } catch (error) {
            console.error("Error fetching models:", error);
            modelsListContainer.innerHTML = `<p class="helper-text">Error loading. ${error.message}</p>`;
        }
    };

    // --- UI Event Listeners ---
    themeToggle.addEventListener('change', (e) => {
        webGLState.isDarkMode = !e.target.checked;
        document.body.classList.toggle('light-mode', !webGLState.isDarkMode);
    });

    opacitySlider.addEventListener('input', (e) => root.style.setProperty('--bubble-opacity', e.target.value / 100));
    textSizeSlider.addEventListener('input', (e) => root.style.setProperty('--font-size-multiplier', e.target.value / 100));
    backgroundZoomSlider.addEventListener('input', (e) => { webGLState.zoom = parseFloat(e.target.value); });
    sidePanelToggle.addEventListener('click', () => sidePanelToggle.parentElement.classList.toggle('collapsed'));
    topDropdownToggle.addEventListener('click', () => topDropdownToggle.parentElement.classList.toggle('collapsed'));
    
    saveForm.addEventListener('submit', (e) => {
        e.preventDefault();
        apiKey = apiKeyInput.value;
        const saveButton = saveForm.querySelector('button');
        saveButton.textContent = 'Saved!';
        setTimeout(() => { saveButton.textContent = 'Save'; }, 2000);
    });

    modelsButton.addEventListener('click', () => {
        modelsPanelContainer.classList.add('visible');
        if (!modelsLoaded) {
            fetchAndDisplayModels();
        }
    });
    
    refreshModelsButton.addEventListener('click', fetchAndDisplayModels);
    
    modelSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredModels = allModelsData.filter(model => 
            (model.name || '').toLowerCase().includes(searchTerm)
        );
        renderModelCards(filteredModels);
    });

    modelsPanelToggle.addEventListener('click', () => {
        modelsPanelContainer.classList.remove('visible');
    });
    
    parametersPanelClose.addEventListener('click', () => {
        parametersPanelContainer.classList.remove('visible');
    });

    sendButton.addEventListener('click', sendMessage);
    chatPromptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // --- WebGL Animation Logic ---
    const canvas = document.getElementById('glcanvas');

    const render = (time) => {
        if (webGLState.lastTime === 0) webGLState.lastTime = time;
        const deltaTime = time - webGLState.lastTime;
        webGLState.lastTime = time;
        webGLState.totalElapsedTime += deltaTime;

        const { gl, uniforms, zoom, isDarkMode, totalElapsedTime } = webGLState;
        
        gl.uniform1f(uniforms.time, totalElapsedTime / 1000.0);
        gl.uniform1f(uniforms.zoom, zoom);
        gl.uniform1f(uniforms.isDarkMode, isDarkMode ? 1.0 : 0.0);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        webGLState.animationFrameId = requestAnimationFrame(render);
    };

    const startAnimation = () => {
        if (!webGLState.animationFrameId && webGLState.gl) {
            webGLState.lastTime = 0;
            webGLState.animationFrameId = requestAnimationFrame(render);
        }
    };

    const stopAnimation = () => {
        if (webGLState.animationFrameId) {
            cancelAnimationFrame(webGLState.animationFrameId);
            webGLState.animationFrameId = null;
        }
    };

    const initWebGL = () => {
        const gl = canvas.getContext('webgl');
        webGLState.gl = gl;

        if (!gl) {
            console.error("WebGL not supported.");
            animationToggle.checked = false;
            animationToggle.disabled = true;
            return;
        }

        const createShader = (t, s) => { const h = gl.createShader(t); gl.shaderSource(h, s); gl.compileShader(h); return h };
        const createProgram = (v, f) => { const p = gl.createProgram(); gl.attachShader(p, v); gl.attachShader(p, f); gl.linkProgram(p); return p };
        
        webGLState.program = createProgram(createShader(gl.VERTEX_SHADER, document.getElementById('vertexShader').textContent), createShader(gl.FRAGMENT_SHADER, document.getElementById('fragmentShader').textContent));
        gl.useProgram(webGLState.program);

        const posBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1]), gl.STATIC_DRAW);
        const posLoc = gl.getAttribLocation(webGLState.program, 'a_position');
        gl.enableVertexAttribArray(posLoc);
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

        webGLState.uniforms = {
            time: gl.getUniformLocation(webGLState.program, 'u_time'),
            zoom: gl.getUniformLocation(webGLState.program, 'u_zoom'),
            isDarkMode: gl.getUniformLocation(webGLState.program, 'u_is_dark_mode')
        };
        
        const handleResize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
        };
        handleResize();
        window.addEventListener('resize', handleResize);

        startAnimation();
    };

    animationToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            startAnimation();
        } else {
            stopAnimation();
        }
    });

    // Initialize on load
    addInitialMessage();
    initWebGL();

  </script>

</body>
</html>
