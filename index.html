
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>tiniest chat</title>
  <style>
    /*
    ================================================================
    |                                                              |
    |                  STYLE DEFINITIONS                           |
    |                                                              |
    ================================================================
    */
    :root {
        /* --- Colors --- */
        --background-color: #000;
        --text-color: #fff;
        --bubble-rgb: 255, 255, 255;
        --bubble-text-color: #000;
        --text-color-rgb: 255, 255, 255;
        --neutral-dark: #333;
        --neutral-light: #ccc;

        /* --- Sizing & Spacing --- */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --toggle-size: 48px;

        /* --- Borders & Radius --- */
        --radius-sm: 0.5rem;
        --radius-md: 1rem;
        --radius-lg: 1.6rem;
        --border-width: 1px;

        /* --- Transitions --- */
        --transition-fast: 0.2s;
        --transition-medium: 0.3s;
        --transition-slow: 0.4s;

        /* --- Opacity & Fonts --- */
        --bubble-opacity: 0.75;
        --font-size-multiplier: 1.0;
    }
    
    body.light-mode {
        --background-color: #fff;
        --text-color: #000;
        --bubble-rgb: 0, 0, 0;
        --bubble-text-color: #fff;
        --text-color-rgb: 0, 0, 0;
    }
    
    *, *::before, *::after {
        box-sizing: border-box;
    }
  
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: var(--text-color);
        background-color: var(--background-color);
        transition: color var(--transition-medium), background-color var(--transition-medium);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden;
    }

    #glcanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
    
    .content {
        position: relative;
        z-index: 1;
        padding: calc(2 * var(--spacing-md));
        text-align: center;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-lg);
        height: 100dvh;
    }
    
    h1 {
        font-size: calc(3rem * var(--font-size-multiplier));
        font-weight: 800;
        margin: 0;
    }
    
    /* --- Base Component & Utility Styles --- */
    .panel {
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        color: var(--bubble-text-color);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        transition: background-color var(--transition-medium), color var(--transition-medium);
        display: flex;
        flex-direction: column;
    }

    .interactive-element {
        cursor: pointer;
        transition: background-color var(--transition-medium), color var(--transition-medium), border-color var(--transition-medium), transform var(--transition-fast);
    }
    .interactive-element:hover {
        transform: scale(1.05);
    }
    .interactive-element svg {
        transition: fill var(--transition-medium);
    }

    /* --- Chat Area --- */
    #chat-area {
        flex-grow: 1;
        width: 100%;
        display: flex;
        flex-direction: column-reverse;
        gap: var(--spacing-md);
        overflow-y: auto;
        padding: var(--spacing-md);
    }

    .message-bubble {
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        max-width: 80%;
        word-wrap: break-word;
        font-size: calc(1rem * var(--font-size-multiplier));
        text-align: left;
        transition: background-color var(--transition-medium), color var(--transition-medium);
    }

    .user-message {
        background-color: rgba(var(--text-color-rgb), var(--bubble-opacity));
        color: var(--background-color);
        align-self: flex-end;
    }

    .model-message {
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        color: var(--bubble-text-color);
        align-self: flex-start;
    }
    
    /* --- Collapsible Panel System --- */
    .collapsible-container {
        position: fixed;
        z-index: 10;
        display: flex;
        gap: var(--spacing-sm);
        transition: transform var(--transition-slow) ease-in-out;
    }
    
    .collapsible-container--right { top: var(--spacing-lg); right: var(--spacing-lg); align-items: center; }
    .collapsible-container--top {
        top: var(--spacing-lg);
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column-reverse;
        align-items: center;
        z-index: 11;
    }
    .collapsible-container--right.collapsed { transform: translateX(calc(100% - var(--toggle-size))); }
    .collapsible-container--top.collapsed {
        transform: translate(-50%, calc(-100% + var(--toggle-size)));
    }

    .side-panel { gap: var(--spacing-md); font-size: calc(0.8rem * var(--font-size-multiplier)); }
    .top-panel { width: 100%; max-width: 500px; font-size: calc(0.9rem * var(--font-size-multiplier)); gap: var(--spacing-md); }

    .collapsible-toggle {
        width: var(--toggle-size);
        height: var(--toggle-size);
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--bubble-rgb), var(--bubble-opacity));
        border-radius: var(--radius-lg);
        flex-shrink: 0;
        transition: background-color var(--transition-medium), transform var(--transition-slow);
    }
    .collapsible-toggle svg {
        width: 24px;
        fill: var(--bubble-text-color);
        transition: transform var(--transition-slow) ease-in-out, fill var(--transition-medium);
    }

    .collapsible-container--right.collapsed .collapsible-toggle svg { transform: rotate(180deg); }
    .collapsible-container--top:not(.collapsed) .collapsible-toggle svg { transform: rotate(180deg); }
    
    /* --- Universal Form Controls --- */
    .control-row { display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-md); }

    .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
    .theme-switch input { display:none; }
    .slider {
        background-color: var(--neutral-dark);
        bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0;
        transition: background-color var(--transition-slow);
        border-radius: 24px;
    }
    .slider:before {
        background-color: #fff; content: ""; position: absolute;
        bottom: 4px; height: 16px; left: 4px; width: 16px;
        transition: transform var(--transition-slow), background-color var(--transition-slow);
        border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--neutral-light); }
    input:checked + .slider:before { background-color: var(--neutral-dark); transform: translateX(20px); }

    .slider-control {
        -webkit-appearance: none;
        width: 120px; height: 8px; background: var(--neutral-dark);
        outline: none; opacity: 0.7; border-radius: 4px;
        transition: opacity var(--transition-fast), background var(--transition-medium);
    }
    .slider-control:hover { opacity: 1; }
    .slider-control::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 18px; height: 18px; background: #ddd; cursor: pointer; border-radius: 50%;
        transition: background var(--transition-medium);
    }
    body.light-mode .slider-control { background: var(--neutral-light); }
    body.light-mode .slider-control::-webkit-slider-thumb { background: var(--neutral-dark); }
    
    .themed-input {
        background-color: rgba(var(--background-color), 0.5);
        color: var(--bubble-text-color);
        border: var(--border-width) solid var(--bubble-text-color);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-family: inherit; font-size: inherit; width: 100%;
        transition: background-color var(--transition-medium), color var(--transition-medium), border-color var(--transition-medium);
    }
    .themed-input::placeholder { color: var(--bubble-text-color); opacity: 0.5; }

    .themed-button {
        background-color: var(--background-color);
        color: var(--text-color);
        border: var(--border-width) solid rgba(var(--text-color), 0.3);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: calc(0.8rem * var(--font-size-multiplier));
    }
    .themed-button:hover { background-color: var(--text-color); color: var(--background-color); }
    .themed-button.disabled {
        background-color: rgba(var(--bubble-rgb), 0.2);
        color: rgba(var(--bubble-text-color), 0.5);
        border-color: rgba(var(--bubble-text-color), 0.2);
        cursor: not-allowed; pointer-events: none;
    }
    .button-container { display: flex; justify-content: flex-end; }
    
    #localhost-config-list .button-container {
        justify-content: flex-start;
    }
    
    /* --- Chat Input Area --- */
    #chat-input-area.panel { max-width: 600px; margin: 0 auto; }
    .chat-input-bubble { display: flex; flex-direction: column; gap: var(--spacing-md); width: 100%; }
    .tag-buttons-container { display: flex; gap: 0.75rem; justify-content: flex-start; align-items: center; flex-wrap: wrap; }
    .chat-input-container { display: flex; align-items: center; width: 100%; font-size: calc(1.25rem * var(--font-size-multiplier)); }
    .chat-input-container .themed-input { background: none; border: none; outline: none; flex-grow: 1; height: auto; padding: 0; }
    .chat-input-container .themed-input::placeholder { color: var(--bubble-text-color); opacity: 0.7; }
    .chat-input-button { background: none; border: none; padding: 0 0 0 var(--spacing-md); }
    .chat-input-button svg { width: 24px; height: 24px; fill: var(--bubble-text-color); }
    
    /* --- Provider Dropdown --- */
    .provider-dropdown { position: relative; display: inline-block; }
    .dropdown-content {
        display: none; position: absolute; bottom: 100%; left: 0;
        background-color: var(--background-color);
        min-width: 160px;
        border: var(--border-width) solid rgba(var(--text-color), 0.3);
        border-radius: var(--radius-sm);
        z-index: 1; margin-bottom: var(--spacing-sm);
    }
    .dropdown-content button { width: 100%; text-align: left; }
    .provider-dropdown.active .dropdown-content { display: block; }

    /* --- Models & Parameters Panels --- */
    .bottom-panel-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translate(-50%, 100%);
        width: 66.66%;
        max-width: calc(1200px * var(--font-size-multiplier));
        height: 85vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-sm);
        transition: transform var(--transition-slow) ease-in-out;
    }
    .bottom-panel-container.visible { transform: translate(-50%, 0); }

    #openrouter-models-panel-container, #localhost-config-panel-container { z-index: 20; }
    #parameters-panel-container { z-index: 21; }

    .main-panel {
        width: 100%;
        height: 100%;
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
    }
    .main-panel-toggle { order: -1; }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }
    #parameters-panel-container .panel-header, #localhost-config-panel-container .panel-header {
        justify-content: center;
    }
    .panel-header h2 { font-size: calc(1.5rem * var(--font-size-multiplier)); white-space: nowrap; margin: 0; }
    .panel-header .themed-input { font-size: calc(1rem * var(--font-size-multiplier)); }

    #models-list, #parameters-list, #localhost-config-list { overflow-y: auto; flex-grow: 1; padding-right: var(--spacing-sm); }
    #models-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(calc(280px * var(--font-size-multiplier)), 1fr)); gap: var(--spacing-md); }
    #parameters-list, #localhost-config-list { display: flex; flex-direction: column; gap: var(--spacing-md); }
    
    .helper-text {
        color: var(--bubble-text-color);
        opacity: 0.7;
        font-size: calc(1rem * var(--font-size-multiplier));
        text-align: center;
        padding-top: calc(2 * var(--spacing-md));
    }
    
    .model-card {
        background-color: var(--background-color);
        color: var(--text-color);
        border: var(--border-width) solid rgba(var(--text-color), 0.3);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        display: flex; flex-direction: column; gap: 0.75rem; text-align: left;
    }
    .model-card:hover { background-color: var(--text-color); color: var(--background-color); transform: translateY(-4px); }
    .model-card h3 { font-size: calc(1.1rem * var(--font-size-multiplier)); margin: 0; font-weight: 600; }
    .model-card p { font-size: calc(0.85rem * var(--font-size-multiplier)); margin: 0; opacity: 0.8; flex-grow: 1; }
    .model-card-footer { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); font-size: calc(0.75rem * var(--font-size-multiplier)); }
    .card-tag {
        background-color: var(--text-color);
        color: var(--background-color);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-md);
        transition: background-color var(--transition-medium), color var(--transition-medium);
    }
    .model-card:hover .card-tag { background-color: var(--background-color); color: var(--text-color); }
    
    /* --- Custom Scrollbar Styles --- */
    #models-list::-webkit-scrollbar, #parameters-list::-webkit-scrollbar, #chat-area::-webkit-scrollbar { width: 12px; }
    #models-list::-webkit-scrollbar-track, #parameters-list::-webkit-scrollbar-track, #chat-area::-webkit-scrollbar-track { background: var(--background-color); border-radius: 10px; }
    #models-list::-webkit-scrollbar-thumb, #parameters-list::-webkit-scrollbar-thumb, #chat-area::-webkit-scrollbar-thumb {
      background-color: var(--text-color);
      border-radius: 10px;
      border: 3px solid var(--background-color);
      background-clip: content-box;
      transition: background-color var(--transition-medium);
    }
    #models-list::-webkit-scrollbar-thumb:hover, #parameters-list::-webkit-scrollbar-thumb:hover, #chat-area::-webkit-scrollbar-thumb:hover { opacity: 0.8; }
    
    @media (max-width: 600px) {
        .bottom-panel-container { width: 90%; }
        #models-list { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  
  <div class="collapsible-container collapsible-container--top collapsed">
      <div class="collapsible-toggle interactive-element" id="top-dropdown-toggle">
          <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
      </div>
      <div class="panel top-panel">
        <form id="save-form">
            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                <input type="text" class="themed-input" id="url-input" name="username" autocomplete="username" placeholder="URL">
                <input type="password" class="themed-input" id="api-key-input" name="password" autocomplete="current-password" placeholder="API">
                <div class="button-container">
                    <button type="submit" class="themed-button interactive-element">Save</button>
                </div>
            </div>
        </form>
      </div>
  </div>

  <div class="collapsible-container collapsible-container--right">
    <div class="collapsible-toggle interactive-element" id="side-panel-toggle">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
    </div>
    <div class="panel side-panel">
        <div class="control-row">
            <span>Theme</span>
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
        </div>
        <div class="control-row">
          <span>Animation</span>
          <label class="theme-switch">
              <input type="checkbox" id="animation-toggle" checked />
              <span class="slider"></span>
          </label>
      </div>
        <div class="control-row">
            <label for="opacity-slider">Opacity</label>
            <input type="range" min="0" max="100" value="75" class="slider-control" id="opacity-slider">
        </div>
        <div class="control-row">
            <label for="background-zoom-slider">BG Zoom</label>
            <input type="range" min="2" max="80" value="80" class="slider-control" id="background-zoom-slider">
        </div>
        <div class="control-row">
            <label for="text-size-slider">Text Size</label>
            <input type="range" min="50" max="150" value="100" class="slider-control" id="text-size-slider">
        </div>
    </div>
  </div>

  <div class="content">
      <div id="chat-area">
         <!-- Messages dynamically added here -->
      </div>
      <div id="chat-input-area" class="panel">
        <div class="chat-input-bubble">
          <div class="tag-buttons-container">
              <div class="provider-dropdown">
                  <button class="themed-button interactive-element" id="provider-button">Provider</button>
                  <div class="dropdown-content">
                      <button class="themed-button interactive-element" data-value="OpenRouter">OpenRouter</button>
                      <button class="themed-button interactive-element" data-value="Localhost">Localhost</button>
                      <button class="themed-button interactive-element" data-value="Custom URL">Custom URL</button>
                  </div>
              </div>
              <button class="themed-button interactive-element" id="openrouter-models-button">Models</button>
              <button class="themed-button interactive-element" id="localhost-config-button">Config</button>
          </div>
          <div class="chat-input-container">
              <input type="text" class="themed-input" id="chat-prompt-input" placeholder="Message...">
              <button class="chat-input-button interactive-element" id="send-button">
                  <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
              </button>
          </div>
        </div>
      </div>
  </div>

  <div id="openrouter-models-panel-container" class="bottom-panel-container">
      <div class="collapsible-toggle main-panel-toggle interactive-element" id="models-panel-main-toggle">
          <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
      </div>
      <div class="panel main-panel">
          <div class="panel-header">
            <h2>Available Models</h2>
            <input type="text" class="themed-input" id="model-search-input" placeholder="Search...">
            <button class="themed-button interactive-element" id="refresh-models-button">Refresh</button>
          </div>
          <div id="models-list">
             <!-- Models will be dynamically inserted here -->
          </div>
      </div>
  </div>
  
  <div id="localhost-config-panel-container" class="bottom-panel-container">
    <div class="collapsible-toggle main-panel-toggle interactive-element" id="localhost-config-panel-close">
        <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
    </div>
    <div class="panel main-panel">
        <div class="panel-header">
          <h2>Presets</h2>
        </div>
        <div id="localhost-config-list">
          <div class="button-container">
              <button class="themed-button interactive-element" id="llama-cpp-button">Llama CPP</button>
          </div>
        </div>
    </div>
  </div>

  <div id="parameters-panel-container" class="bottom-panel-container">
    <div class="collapsible-toggle main-panel-toggle interactive-element" id="parameters-panel-close">
        <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
    </div>
    <div class="panel main-panel">
        <div class="panel-header">
          <h2>Supported Parameters</h2>
        </div>
        <div id="parameters-list">
           <!-- Parameters will be dynamically inserted here -->
        </div>
    </div>
  </div>

  <canvas id="glcanvas"></canvas>
  <iframe name="form-target" style="display: none;"></iframe>

  <script id="vertexShader" type="x-shader/x-vertex">
    attribute vec2 a_position;
    varying vec2 v_uv;
    void main() {
      v_uv = a_position * 0.5 + 0.5;
      gl_Position = vec4(a_position, 0.0, 1.0);
    }
  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">
    precision highp float;
    varying vec2 v_uv;
    uniform float u_time;
    uniform float u_zoom;
    uniform float u_is_dark_mode;
    
    float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
    float noise(vec2 p) {
      vec2 i = floor(p); vec2 f = fract(p); vec2 u = f*f*(3.0-2.0*f);
      return mix(mix(hash(i + vec2(0.0, 0.0)), hash(i + vec2(1.0, 0.0)), u.x),
                 mix(hash(i + vec2(0.0, 1.0)), hash(i + vec2(1.0, 1.0)), u.x), u.y);
    }
    float fbm(vec2 p) {
      float f = 0.0; float amp = 0.5;
      for (int i = 0; i < 4; i++) { f += amp * noise(p); p *= 2.0; amp *= 0.5; }
      return f;
    }
    vec2 voronoi(vec2 p) {
      vec2 i = floor(p); vec2 f = fract(p);
      float min_dist=1.0, second_min_dist=1.0;
      for (int y=-1; y<=1; y++) {
        for (int x=-1; x<=1; x++) {
          vec2 nc = vec2(float(x), float(y));
          float d = fbm((i + nc) * 0.1 + u_time * 0.005);
          vec2 p_ = nc + 0.5 + (d - 0.5) * 0.8;
          float dist = length(f - p_);
          if (dist < min_dist) { second_min_dist = min_dist; min_dist = dist; }
          else if (dist < second_min_dist) { second_min_dist = dist; }
        }
      }
      return vec2(min_dist, second_min_dist);
    }

    void main() {
      vec2 p = v_uv * u_zoom; p.x += u_time * 0.002;
      vec2 v = voronoi(p);
      float border = smoothstep(0.01, 0.0125, v.y - v.x);
      vec3 color = mix(vec3(border), vec3(1.0 - border), u_is_dark_mode);
      gl_FragColor = vec4(color, 1.0);
    }
  </script>

  <script>
    /*
    ================================================================
    |                                                              |
    |                  APPLICATION SCRIPT                          |
    |                                                              |
    ================================================================
    */
    // IIFE to encapsulate all logic and prevent global scope pollution
    (function() {
      'use strict';

      // ========================================================== //
      // ===================== AppState Class ===================== //
      // ========================================================== //
      class AppState {
        constructor() {
          this.modelsLoaded = false;
          this.allModelsData = [];
          this.currentSelectedModel = null;
          this.apiKey = '';
          this.chatHistory = [];
          this.isDarkMode = true;
          this.zoom = 80.0;
          this.baseUrl = 'https://openrouter.ai/api/v1/chat/completions'; // Default URL
        }

        addMessage(role, content) {
          this.chatHistory.push({ role, content });
        }

        updateLastMessage(newContent) {
            if (this.chatHistory.length > 0) {
                this.chatHistory[this.chatHistory.length - 1].content = newContent;
            }
        }
      }

      // ========================================================== //
      // ==================== WebGLAnimator Class ================= //
      // ========================================================== //
      class WebGLAnimator {
        constructor(canvasId, vertexShaderId, fragmentShaderId, appState) {
          this.canvas = document.getElementById(canvasId);
          this.appState = appState;
          this.gl = this.canvas.getContext('webgl');
          this.program = null;
          this.uniforms = {};
          this.animationFrameId = null;
          this.lastTime = 0;
          this.totalElapsedTime = 0;
          
          this.vertexShaderSource = document.getElementById(vertexShaderId).textContent;
          this.fragmentShaderSource = document.getElementById(fragmentShaderId).textContent;
        }
        
        init() {
          if (!this.gl) {
            console.error("WebGL not supported.");
            return false;
          }

          const createShader = (type, source) => {
            const shader = this.gl.createShader(type);
            this.gl.shaderSource(shader, source);
            this.gl.compileShader(shader);
            return shader;
          };

          const createProgram = (vs, fs) => {
            const prog = this.gl.createProgram();
            this.gl.attachShader(prog, vs);
            this.gl.attachShader(prog, fs);
            this.gl.linkProgram(prog);
            return prog;
          };

          this.program = createProgram(
            createShader(this.gl.VERTEX_SHADER, this.vertexShaderSource),
            createShader(this.gl.FRAGMENT_SHADER, this.fragmentShaderSource)
          );
          
          this.gl.useProgram(this.program);
          
          const posBuffer = this.gl.createBuffer();
          this.gl.bindBuffer(this.gl.ARRAY_BUFFER, posBuffer);
          this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array([-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1]), this.gl.STATIC_DRAW);
          const posLoc = this.gl.getAttribLocation(this.program, 'a_position');
          this.gl.enableVertexAttribArray(posLoc);
          this.gl.vertexAttribPointer(posLoc, 2, this.gl.FLOAT, false, 0, 0);

          this.uniforms = {
            time: this.gl.getUniformLocation(this.program, 'u_time'),
            zoom: this.gl.getUniformLocation(this.program, 'u_zoom'),
            isDarkMode: this.gl.getUniformLocation(this.program, 'u_is_dark_mode')
          };
          
          this.handleResize();
          window.addEventListener('resize', () => this.handleResize());
          this.start();
          return true;
        }

        handleResize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);
        }

        render(time) {
          if (this.lastTime === 0) this.lastTime = time;
          const deltaTime = time - this.lastTime;
          this.lastTime = time;
          this.totalElapsedTime += deltaTime;

          this.gl.uniform1f(this.uniforms.time, this.totalElapsedTime / 1000.0);
          this.gl.uniform1f(this.uniforms.zoom, this.appState.zoom);
          this.gl.uniform1f(this.uniforms.isDarkMode, this.appState.isDarkMode ? 1.0 : 0.0);
          this.gl.clear(this.gl.COLOR_BUFFER_BIT);
          this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
          
          this.animationFrameId = requestAnimationFrame(this.render.bind(this));
        }

        start() {
          if (!this.animationFrameId) {
            this.lastTime = 0;
            this.animationFrameId = requestAnimationFrame(this.render.bind(this));
          }
        }

        stop() {
          if (this.animationFrameId) {
            cancelAnimationFrame(this.animationFrameId);
            this.animationFrameId = null;
          }
        }
      }

      // ========================================================== //
      // ==================== ApiClient Class ===================== //
      // ========================================================== //
      class ApiClient {
        constructor(state) {
            this.state = state;
        }

        async fetchModels() {
            try {
                const response = await fetch('https://openrouter.ai/api/v1/models');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const { data } = await response.json();
                this.state.allModelsData = data;
                this.state.modelsLoaded = true;
                return { success: true, data };
            } catch (error) {
                console.error("Error fetching models:", error);
                return { success: false, error };
            }
        }

        async getChatCompletion() {
            const headers = {
                'Content-Type': 'application/json'
            };

            if (this.state.apiKey) {
                headers['Authorization'] = `Bearer ${this.state.apiKey}`;
            }
            
            const requestBody = {
                messages: this.state.chatHistory.slice(0, -1)
            };

            if (this.state.currentSelectedModel) {
                requestBody.model = this.state.currentSelectedModel.id;
            }
            
            console.log("----- Sending Request -----");
            console.log("URL:", this.state.baseUrl);
            console.log("Headers:", headers);
            console.log("Body:", JSON.stringify(requestBody, null, 2));

            try {
                const response = await fetch(this.state.baseUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                const responseData = await response.json();
                console.log("----- Received Response -----");
                console.log("Status:", response.status);
                console.log("Status Text:", response.statusText);
                console.log("Data:", responseData);

                if (!response.ok) {
                    throw new Error(responseData.error?.message || `HTTP error! status: ${response.status}`);
                }
                
                const modelResponse = responseData.choices[0].message.content;
                return { success: true, content: modelResponse };

            } catch (error) {
                console.error('Error during API call:', error);
                return { success: false, error };
            }
        }
      }


      // ========================================================== //
      // ===================== UIManager Class ==================== //
      // ========================================================== //
      class UIManager {
        constructor(state, apiClient, webGLAnimator) {
          this.state = state;
          this.apiClient = apiClient;
          this.webGLAnimator = webGLAnimator;
          this.root = document.documentElement;
          this.queryDOMElements();
          this.openRouterModelsButton.style.display = 'none';
          this.localhostConfigButton.style.display = 'none';
          this.urlInput.value = this.state.baseUrl;
          this.mobileMediaQuery = window.matchMedia('(max-width: 600px)');
          this.topToggleAlignmentOffset = 0;
          this.isTextSliderActive = false; // Flag to track slider drag state

          // Properties to store the measured range.
          this.minToggleX = 0;
          this.maxToggleX = 0;
          this.initialApiToggleX = 0;
        }

        queryDOMElements() {
          this.themeToggle = document.getElementById('theme-toggle');
          this.animationToggle = document.getElementById('animation-toggle');
          this.opacitySlider = document.getElementById('opacity-slider');
          this.textSizeSlider = document.getElementById('text-size-slider');
          this.backgroundZoomSlider = document.getElementById('background-zoom-slider');
          this.sidePanelToggle = document.getElementById('side-panel-toggle');
          this.topDropdownToggle = document.getElementById('top-dropdown-toggle');
          this.saveForm = document.getElementById('save-form');
          this.urlInput = document.getElementById('url-input');
          this.apiKeyInput = document.getElementById('api-key-input');
          this.providerDropdown = document.querySelector('.provider-dropdown');
          this.providerButton = document.getElementById('provider-button');
          this.openRouterModelsButton = document.getElementById('openrouter-models-button');
          this.localhostConfigButton = document.getElementById('localhost-config-button');
          this.openRouterModelsPanelContainer = document.getElementById('openrouter-models-panel-container');
          this.localhostConfigPanelContainer = document.getElementById('localhost-config-panel-container');
          this.modelsPanelToggle = document.getElementById('models-panel-main-toggle');
          this.localhostConfigPanelClose = document.getElementById('localhost-config-panel-close');
          this.llamaCppButton = document.getElementById('llama-cpp-button');
          this.refreshModelsButton = document.getElementById('refresh-models-button');
          this.modelsListContainer = document.getElementById('models-list');
          this.modelSearchInput = document.getElementById('model-search-input');
          this.parametersPanelContainer = document.getElementById('parameters-panel-container');
          this.parametersPanelClose = document.getElementById('parameters-panel-close');
          this.parametersList = document.getElementById('parameters-list');
          this.chatPromptInput = document.getElementById('chat-prompt-input');
          this.sendButton = document.getElementById('send-button');
          this.chatArea = document.getElementById('chat-area');
        }

        initializeEventListeners() {
          this.themeToggle.addEventListener('change', e => this.handleThemeToggle(e));
          this.animationToggle.addEventListener('change', e => this.handleAnimationToggle(e));
          this.opacitySlider.addEventListener('input', e => this.root.style.setProperty('--bubble-opacity', e.target.value / 100));
          
          this.textSizeSlider.addEventListener('input', e => {
              this.root.style.setProperty('--font-size-multiplier', e.target.value / 100);
              this.updateApiTogglePositionLinearly();
          });
          
          // NEW: Robust drag handling using a flag
          const handleDragStart = () => {
              this.isTextSliderActive = true;
          };
          const handleDragEnd = () => {
              this.isTextSliderActive = false;
              // Call one last time to ensure the transition style is correctly reset
              this.updateTopTogglePosition();
          };
          this.textSizeSlider.addEventListener('mousedown', handleDragStart);
          this.textSizeSlider.addEventListener('touchstart', handleDragStart);
          window.addEventListener('mouseup', handleDragEnd);
          window.addEventListener('touchend', handleDragEnd);

          
          this.backgroundZoomSlider.addEventListener('input', e => this.state.zoom = parseFloat(e.target.value));

          this.sidePanelToggle.addEventListener('click', () => this.handleSideToggleClick());
          this.topDropdownToggle.addEventListener('click', () => this.handleTopToggleClick());
          this.mobileMediaQuery.addEventListener('change', () => this.captureInitialPositions());

          this.openRouterModelsButton.addEventListener('click', () => this.handleOpenRouterModelsButtonClick());
          this.localhostConfigButton.addEventListener('click', () => this.localhostConfigPanelContainer.classList.add('visible'));
          this.modelsPanelToggle.addEventListener('click', () => this.openRouterModelsPanelContainer.classList.remove('visible'));
          this.localhostConfigPanelClose.addEventListener('click', () => this.localhostConfigPanelContainer.classList.remove('visible'));
          this.parametersPanelClose.addEventListener('click', () => this.parametersPanelContainer.classList.remove('visible'));
          this.llamaCppButton.addEventListener('click', () => this.handleLlamaCppPresetClick());

          this.saveForm.addEventListener('submit', e => this.handleSaveForm(e));
          this.sendButton.addEventListener('click', () => this.handleSendMessage());
          this.chatPromptInput.addEventListener('keydown', e => { if (e.key === 'Enter') this.handleSendMessage(); });

          this.refreshModelsButton.addEventListener('click', () => this.fetchAndDisplayModels());
          this.modelSearchInput.addEventListener('input', e => this.filterAndRenderModels(e.target.value));
          
          this.providerButton.addEventListener('click', () => this.providerDropdown.classList.toggle('active'));
          this.providerDropdown.querySelectorAll('.dropdown-content button').forEach(button => {
              button.addEventListener('click', () => this.handleProviderSelection(button.dataset.value));
          });
          window.addEventListener('click', (e) => {
              if (!this.providerDropdown.contains(e.target)) {
                  this.providerDropdown.classList.remove('active');
              }
          });
        }
        
        updateApiTogglePositionLinearly() {
            if (this.minToggleX === 0 || this.maxToggleX === 0) return; // Don't run if not initialized

            const minSlider = parseFloat(this.textSizeSlider.min);
            const maxSlider = parseFloat(this.textSizeSlider.max);
            const currentSlider = parseFloat(this.textSizeSlider.value);
            const progress = (currentSlider - minSlider) / (maxSlider - minSlider);
            const targetSideToggleX = this.minToggleX + (this.maxToggleX - this.minToggleX) * progress;
            this.topToggleAlignmentOffset = targetSideToggleX - this.initialApiToggleX;
            this.updateTopTogglePosition();
        }

        async captureInitialPositions() {
            if (!this.mobileMediaQuery.matches) {
                this.minToggleX = 0; // Reset if not on mobile
                return;
            }

            const sidePanelContainer = this.sidePanelToggle.parentElement;
            const originalSliderValue = this.textSizeSlider.value;

            sidePanelContainer.style.transition = 'none';
            sidePanelContainer.style.visibility = 'hidden';

            const measure = () => {
                const sideRect = this.sidePanelToggle.getBoundingClientRect();
                return sideRect.left + sideRect.width / 2;
            }

            const nextFrame = () => new Promise(resolve => requestAnimationFrame(resolve));

            this.textSizeSlider.value = this.textSizeSlider.min;
            this.root.style.setProperty('--font-size-multiplier', this.textSizeSlider.min / 100);
            await nextFrame();
            this.minToggleX = measure();

            this.textSizeSlider.value = this.textSizeSlider.max;
            this.root.style.setProperty('--font-size-multiplier', this.textSizeSlider.max / 100);
            await nextFrame();
            this.maxToggleX = measure();
            
            this.textSizeSlider.value = originalSliderValue;
            this.root.style.setProperty('--font-size-multiplier', originalSliderValue / 100);
            await nextFrame();
            const topRect = this.topDropdownToggle.getBoundingClientRect();
            this.initialApiToggleX = topRect.left + topRect.width / 2;

            sidePanelContainer.style.visibility = '';
            sidePanelContainer.style.transition = '';

            this.updateApiTogglePositionLinearly();
        }


        updateTopTogglePosition() {
            const topToggle = this.topDropdownToggle;
            if (!this.mobileMediaQuery.matches) {
                topToggle.style.transform = '';
                return;
            }
            const sidePanelIsOpen = !this.sidePanelToggle.parentElement.classList.contains('collapsed');
            if (sidePanelIsOpen) {
                // MODIFIED: Use the flag to disable transition
                topToggle.style.transition = this.isTextSliderActive ? 'none' : '';
                topToggle.style.transform = `translateX(${this.topToggleAlignmentOffset}px)`;
            } else {
                topToggle.style.transition = '';
                topToggle.style.transform = '';
            }
        }
        
        handleTopToggleClick() {
            const isOpening = this.topDropdownToggle.parentElement.classList.contains('collapsed');
            if (this.mobileMediaQuery.matches && isOpening) {
                this.sidePanelToggle.parentElement.classList.add('collapsed');
            }
            this.topDropdownToggle.parentElement.classList.toggle('collapsed');
            this.updateTopTogglePosition();
        }
    
        handleSideToggleClick() {
            const isOpening = this.sidePanelToggle.parentElement.classList.contains('collapsed');
            if (this.mobileMediaQuery.matches && isOpening) {
                this.topDropdownToggle.parentElement.classList.add('collapsed');
            }
            this.sidePanelToggle.parentElement.classList.toggle('collapsed');
            this.updateTopTogglePosition();
        }

        handleThemeToggle(e) {
          this.state.isDarkMode = !e.target.checked;
          document.body.classList.toggle('light-mode', !this.state.isDarkMode);
        }

        handleAnimationToggle(e) {
            if (!this.webGLAnimator) return;
            if (e.target.checked) this.webGLAnimator.start();
            else this.webGLAnimator.stop();
        }

        handleSaveForm(e) {
            e.preventDefault();
            this.state.apiKey = this.apiKeyInput.value;
            this.state.baseUrl = this.urlInput.value;
            const saveButton = this.saveForm.querySelector('button');
            saveButton.textContent = 'Saved!';
            setTimeout(() => { saveButton.textContent = 'Save'; }, 2000);
        }
        
        handleProviderSelection(provider) {
            this.providerButton.textContent = provider;

            this.openRouterModelsButton.style.display = 'none';
            this.localhostConfigButton.style.display = 'none';
            this.openRouterModelsPanelContainer.classList.remove('visible');
            this.localhostConfigPanelContainer.classList.remove('visible');
            
            if (provider === 'OpenRouter') {
                this.openRouterModelsButton.style.display = '';
                this.state.baseUrl = 'https://openrouter.ai/api/v1/chat/completions';
            } else if (provider === 'Localhost') {
                this.localhostConfigButton.style.display = '';
                this.state.baseUrl = 'http://localhost:8080/v1/chat/completions'; // Default for localhost
            } else { // Custom URL
                this.state.baseUrl = ''; // Clear it for custom
            }
            this.urlInput.value = this.state.baseUrl;
            
            const existingModelButton = document.getElementById('selected-model-display-button');
            if (existingModelButton) {
                existingModelButton.remove();
            }
            this.state.currentSelectedModel = null;
            
            this.providerDropdown.classList.remove('active');
        }

        handleOpenRouterModelsButtonClick() {
            if (this.openRouterModelsButton.style.display === 'none') return;
            this.modelsListContainer.scrollTop = 0;
            this.openRouterModelsPanelContainer.classList.add('visible');
            if (!this.state.modelsLoaded) {
                this.fetchAndDisplayModels();
            }
        }
        
        handleLlamaCppPresetClick() {
            this.state.baseUrl = 'http://localhost:8080/v1/chat/completions';
            this.urlInput.value = this.state.baseUrl;
            this.state.currentSelectedModel = null; // Llama.cpp doesn't use named models in the same way
            const existingModelButton = document.getElementById('selected-model-display-button');
            if (existingModelButton) existingModelButton.remove();
            this.localhostConfigPanelContainer.classList.remove('visible');
        }

        async handleSendMessage() {
            const userPrompt = this.chatPromptInput.value.trim();
            if (!userPrompt) return;

            this.state.addMessage('user', userPrompt);
            this.renderChatHistory(); 
            this.chatPromptInput.value = '';

            if (!this.state.apiKey && this.providerButton.textContent === 'OpenRouter') {
                this.state.addMessage('assistant', 'Error: API key is not set for OpenRouter.');
                this.renderChatHistory();
                return;
            }
            if (!this.state.currentSelectedModel && this.providerButton.textContent === 'OpenRouter') {
                this.state.addMessage('assistant', 'Error: No model selected for OpenRouter.');
                this.renderChatHistory();
                return;
            }

            this.state.addMessage('assistant', 'Thinking...');
            this.renderChatHistory();

            const result = await this.apiClient.getChatCompletion();

            if (result.success) {
                this.state.updateLastMessage(result.content);
            } else {
                this.state.updateLastMessage(`Error: ${result.error.message}`);
            }
            this.renderChatHistory();
        }
        
        renderChatHistory() {
            this.chatArea.innerHTML = '';
            [...this.state.chatHistory].forEach(msg => {
                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble ${msg.role === 'user' ? 'user-message' : 'model-message'}`;
                messageBubble.textContent = msg.content;
                this.chatArea.prepend(messageBubble);
            });
            this.chatArea.scrollTop = 0;
        }

        async fetchAndDisplayModels() {
            this.modelsListContainer.innerHTML = `<p class="helper-text">Loading models...</p>`;
            const result = await this.apiClient.fetchModels();
            if (result.success) {
                this.renderModelCards(result.data);
            } else {
                this.modelsListContainer.innerHTML = `<p class="helper-text">Error loading. ${result.error.message}</p>`;
            }
        }

        filterAndRenderModels(searchTerm) {
            const filtered = this.state.allModelsData.filter(model =>
                (model.name || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            this.renderModelCards(filtered);
        }

        renderModelCards(models) {
            this.modelsListContainer.innerHTML = '';
            if (!models || models.length === 0) {
                this.modelsListContainer.innerHTML = `<p class="helper-text">No models found.</p>`;
                return;
            }
            models.forEach(model => {
                const card = this.createModelCard(model);
                this.modelsListContainer.appendChild(card);
            });
        }
        
        createModelCard(model) {
            const card = document.createElement('button');
            card.className = 'model-card interactive-element';
            card.dataset.id = model.id;
            card.addEventListener('click', () => this.selectModel(model));

            const formatPrice = (p) => p > 0 ? `$${(parseFloat(p) * 1_000_000).toFixed(2)}/M` : 'Free';
            
            card.innerHTML = `
                <h3>${model.name || 'Unnamed Model'}</h3>
                <p>${model.description || 'No description available.'}</p>
                <div class="model-card-footer">
                    <span class="card-tag">Context: ${model.context_length ? (model.context_length / 1000) + 'k' : 'N/A'}</span>
                    <span class="card-tag">In: ${model.architecture?.input_modalities?.join(', ') || 'N/A'}</span>
                    <span class="card-tag">Out: ${model.architecture?.output_modalities?.join(', ') || 'N/A'}</span>
                    <span class="card-tag">Prompt: ${formatPrice(model.pricing.prompt)}</span>
                    <span class="card-tag">Completion: ${formatPrice(model.pricing.completion)}</span>
                </div>
            `;
            return card;
        }
        
        selectModel(model) {
            this.state.currentSelectedModel = model;
            this.state.baseUrl = 'https://openrouter.ai/api/v1/chat/completions';
            this.urlInput.value = this.state.baseUrl;
            
            const existingModelButton = document.getElementById('selected-model-display-button');
            if (existingModelButton) existingModelButton.remove();

            const button = document.createElement('button');
            button.id = 'selected-model-display-button';
            button.className = 'themed-button interactive-element';
            button.textContent = model.name;
            button.addEventListener('click', () => this.showSupportedParameters(model));
            
            document.querySelector('.tag-buttons-container').insertBefore(button, this.openRouterModelsButton.nextSibling);
            this.openRouterModelsPanelContainer.classList.remove('visible');
        }

        showSupportedParameters(model) {
            this.parametersList.innerHTML = ''; // Clear previous
             if (model.supported_parameters?.length > 0) {
                this.parametersList.innerHTML = `<p class="helper-text">Parameters supported: ${model.supported_parameters.join(', ')}</p><p class="helper-text">(Full UI for params can be built out here)</p>`;
             } else {
                this.parametersList.innerHTML = `<p class="helper-text">No supported parameters listed for this model.</p>`;
             }
             this.parametersPanelContainer.classList.add('visible');
        }
      }

      // ========================================================== //
      // ================= APP INITIALIZATION ===================== //
      // ========================================================== //
      document.addEventListener('DOMContentLoaded', () => {
        const appState = new AppState();
        const webGLAnimator = new WebGLAnimator('glcanvas', 'vertexShader', 'fragmentShader', appState);
        const apiClient = new ApiClient(appState);
        const uiManager = new UIManager(appState, apiClient, webGLAnimator);

        const webglInitialized = webGLAnimator.init();
        if (!webglInitialized) {
            uiManager.animationToggle.checked = false;
            uiManager.animationToggle.disabled = true;
        }

        uiManager.initializeEventListeners();
        
        // Use requestAnimationFrame to ensure the initial layout is painted before we measure it.
        requestAnimationFrame(async () => {
          await uiManager.captureInitialPositions();
        });
        
        appState.addMessage('assistant', 'Welcome to tiniest chat!');
        uiManager.renderChatHistory();
      });

    })();
  </script>

</body>
</html>
